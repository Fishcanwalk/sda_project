{% extends "base/base-page.html" %}

{% block content %}
<div class="container mx-auto p-4 space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-base-content">IoT Dashboard</h1>
            <p class="text-base-content/70 mt-1">Real-time sensor monitoring</p>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-sm btn-outline" onclick="refreshAllSensors()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh
            </button>
            <div class="badge badge-success gap-2">
                <div class="w-2 h-2 rounded-full bg-white animate-pulse"></div>
                Live
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Temperature Card -->
        <div class="card bg-gradient-to-br from-orange-500 to-red-500 text-white shadow-xl hover:shadow-2xl transition-all">
            <div class="card-body">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="card-title text-white/90 text-sm font-normal">Temperature</h2>
                        <p class="text-4xl font-bold mt-2" id="temp-value">--</p>
                        <p class="text-white/80 text-sm mt-1">Â°C</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-white/70">
                        <span>Min: <span id="temp-min">--</span>Â°C</span>
                        <span>Max: <span id="temp-max">--</span>Â°C</span>
                    </div>
                    <div class="text-xs text-white/60 mt-2" id="temp-time">Updated: --</div>
                </div>
            </div>
        </div>

        <!-- Humidity Card -->
        <div class="card bg-gradient-to-br from-blue-500 to-cyan-500 text-white shadow-xl hover:shadow-2xl transition-all">
            <div class="card-body">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="card-title text-white/90 text-sm font-normal">Humidity</h2>
                        <p class="text-4xl font-bold mt-2" id="humidity-value">--</p>
                        <p class="text-white/80 text-sm mt-1">%</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                        </svg>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-white/70">
                        <span>Min: <span id="humidity-min">--</span>%</span>
                        <span>Max: <span id="humidity-max">--</span>%</span>
                    </div>
                    <div class="text-xs text-white/60 mt-2" id="humidity-time">Updated: --</div>
                </div>
            </div>
        </div>

        <!-- Light Card -->
        <div class="card bg-gradient-to-br from-yellow-400 to-orange-400 text-white shadow-xl hover:shadow-2xl transition-all">
            <div class="card-body">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="card-title text-white/90 text-sm font-normal">Light Intensity</h2>
                        <p class="text-4xl font-bold mt-2" id="light-value">--</p>
                        <p class="text-white/80 text-sm mt-1">lux</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-white/70">
                        <span>Min: <span id="light-min">--</span></span>
                        <span>Max: <span id="light-max">--</span></span>
                    </div>
                    <div class="text-xs text-white/60 mt-2" id="light-time">Updated: --</div>
                </div>
            </div>
        </div>

        <!-- Rain Card -->
        <div class="card bg-gradient-to-br from-indigo-500 to-purple-500 text-white shadow-xl hover:shadow-2xl transition-all">
            <div class="card-body">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="card-title text-white/90 text-sm font-normal">Rainfall</h2>
                        <p class="text-4xl font-bold mt-2" id="rain-value">--</p>
                        <p class="text-white/80 text-sm mt-1">mm</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                        </svg>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-white/70">
                        <span>Today: <span id="rain-today">--</span>mm</span>
                        <span>Status: <span id="rain-status">--</span></span>
                    </div>
                    <div class="text-xs text-white/60 mt-2" id="rain-time">Updated: --</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Temperature Chart -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-lg">Temperature Trend (24h)</h2>
                <div class="h-64">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Humidity Chart -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-lg">Humidity Trend (24h)</h2>
                <div class="h-64">
                    <canvas id="humidityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Light Chart -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-lg">Light Intensity (24h)</h2>
                <div class="h-64">
                    <canvas id="lightChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Rain Chart -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-lg">Rainfall (24h)</h2>
                <div class="h-64">
                    <canvas id="rainChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Alerts -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-lg mb-4">Recent Alerts</h2>
            <div class="space-y-2" id="alerts-container">
                <!-- Alerts will be populated by JavaScript -->
                <div class="alert alert-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>All sensors are operating normally</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sensor Details Table -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-lg mb-4">Sensor Details</h2>
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Sensor Type</th>
                            <th>Current Value</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th>Node</th>
                        </tr>
                    </thead>
                    <tbody id="sensor-table-body">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Chart configurations
let tempChart, humidityChart, lightChart, rainChart;

// Initialize charts
function initCharts() {
    const chartConfig = {
        type: 'line',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    };

    // Temperature Chart
    tempChart = new Chart(document.getElementById('tempChart'), {
        ...chartConfig,
        data: {
            labels: [],
            datasets: [{
                label: 'Temperature (Â°C)',
                data: [],
                borderColor: 'rgb(249, 115, 22)',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                tension: 0.4,
                fill: true
            }]
        }
    });

    // Humidity Chart
    humidityChart = new Chart(document.getElementById('humidityChart'), {
        ...chartConfig,
        data: {
            labels: [],
            datasets: [{
                label: 'Humidity (%)',
                data: [],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        }
    });

    // Light Chart
    lightChart = new Chart(document.getElementById('lightChart'), {
        ...chartConfig,
        data: {
            labels: [],
            datasets: [{
                label: 'Light (lux)',
                data: [],
                borderColor: 'rgb(251, 191, 36)',
                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                tension: 0.4,
                fill: true
            }]
        }
    });

    // Rain Chart
    rainChart = new Chart(document.getElementById('rainChart'), {
        ...chartConfig,
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Rain (mm)',
                data: [],
                backgroundColor: 'rgba(99, 102, 241, 0.6)',
                borderColor: 'rgb(99, 102, 241)',
                borderWidth: 1
            }]
        }
    });
}

// Fetch and update sensor data
async function fetchSensorData(sensorType, endpoint) {
    try {
        const response = await fetch(endpoint);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error(`Error fetching ${sensorType}:`, error);
        return null;
    }
}

// Update dashboard
async function updateDashboard() {
    // Fetch latest data for each sensor type
    const [tempData, humidityData, lightData, rainData] = await Promise.all([
        fetchSensorData('temperature', '/sensors/temperature/latest'),
        fetchSensorData('humidity', '/sensors/humidity/latest'),
        fetchSensorData('light', '/sensors/light/latest'),
        fetchSensorData('rain', '/sensors/rain/latest')
    ]);

    // Update cards
    if (tempData) {
        document.getElementById('temp-value').textContent = tempData.value.toFixed(1);
        document.getElementById('temp-min').textContent = tempData.min.toFixed(1);
        document.getElementById('temp-max').textContent = tempData.max.toFixed(1);
        document.getElementById('temp-time').textContent = `Updated: ${formatTime(tempData.timestamp)}`;
    }

    if (humidityData) {
        document.getElementById('humidity-value').textContent = humidityData.value.toFixed(1);
        document.getElementById('humidity-min').textContent = humidityData.min.toFixed(1);
        document.getElementById('humidity-max').textContent = humidityData.max.toFixed(1);
        document.getElementById('humidity-time').textContent = `Updated: ${formatTime(humidityData.timestamp)}`;
    }

    if (lightData) {
        document.getElementById('light-value').textContent = lightData.value.toFixed(0);
        document.getElementById('light-min').textContent = lightData.min.toFixed(0);
        document.getElementById('light-max').textContent = lightData.max.toFixed(0);
        document.getElementById('light-time').textContent = `Updated: ${formatTime(lightData.timestamp)}`;
    }

    if (rainData) {
        document.getElementById('rain-value').textContent = rainData.value.toFixed(1);
        document.getElementById('rain-today').textContent = rainData.total_today.toFixed(1);
        document.getElementById('rain-status').textContent = rainData.value > 0 ? 'Raining' : 'Dry';
        document.getElementById('rain-time').textContent = `Updated: ${formatTime(rainData.timestamp)}`;
    }

    // Update charts with historical data
    await updateCharts();
    
    // Update sensor table
    updateSensorTable([tempData, humidityData, lightData, rainData]);
    
    // Check for alerts
    checkAlerts([tempData, humidityData, lightData, rainData]);
}

// Update charts with historical data
async function updateCharts() {
    const [tempHistory, humidityHistory, lightHistory, rainHistory] = await Promise.all([
        fetchSensorData('temperature', '/sensors/temperature/history?hours=24'),
        fetchSensorData('humidity', '/sensors/humidity/history?hours=24'),
        fetchSensorData('light', '/sensors/light/history?hours=24'),
        fetchSensorData('rain', '/sensors/rain/history?hours=24')
    ]);

    if (tempHistory) {
        tempChart.data.labels = tempHistory.map(d => formatTime(d.timestamp));
        tempChart.data.datasets[0].data = tempHistory.map(d => d.value);
        tempChart.update();
    }

    if (humidityHistory) {
        humidityChart.data.labels = humidityHistory.map(d => formatTime(d.timestamp));
        humidityChart.data.datasets[0].data = humidityHistory.map(d => d.value);
        humidityChart.update();
    }

    if (lightHistory) {
        lightChart.data.labels = lightHistory.map(d => formatTime(d.timestamp));
        lightChart.data.datasets[0].data = lightHistory.map(d => d.value);
        lightChart.update();
    }

    if (rainHistory) {
        rainChart.data.labels = rainHistory.map(d => formatTime(d.timestamp));
        rainChart.data.datasets[0].data = rainHistory.map(d => d.value);
        rainChart.update();
    }
}

// Update sensor details table
function updateSensorTable(sensorData) {
    const tbody = document.getElementById('sensor-table-body');
    const sensors = [
        { type: 'Temperature', data: sensorData[0], unit: 'Â°C', icon: 'ðŸŒ¡ï¸' },
        { type: 'Humidity', data: sensorData[1], unit: '%', icon: 'ðŸ’§' },
        { type: 'Light', data: sensorData[2], unit: 'lux', icon: 'ðŸ’¡' },
        { type: 'Rain', data: sensorData[3], unit: 'mm', icon: 'ðŸŒ§ï¸' }
    ];

    tbody.innerHTML = sensors.map(s => {
        if (!s.data) return '';
        const statusClass = getStatusClass(s.type, s.data.value);
        return `
            <tr>
                <td>
                    <div class="flex items-center gap-2">
                        <span class="text-xl">${s.icon}</span>
                        <span class="font-medium">${s.type}</span>
                    </div>
                </td>
                <td class="font-semibold">${s.data.value.toFixed(2)} ${s.unit}</td>
                <td><span class="badge ${statusClass}">Normal</span></td>
                <td>${formatTime(s.data.timestamp)}</td>
                <td>${s.data.title || 'N/A'}</td>
            </tr>
        `;
    }).join('');
}

// Check for alerts
function checkAlerts(sensorData) {
    const alerts = [];
    const [temp, humidity, light, rain] = sensorData;

    if (temp && temp.value > 35) {
        alerts.push({ type: 'warning', message: `High temperature detected: ${temp.value.toFixed(1)}Â°C` });
    }
    if (humidity && humidity.value > 90) {
        alerts.push({ type: 'info', message: `High humidity: ${humidity.value.toFixed(1)}%` });
    }
    if (rain && rain.value > 10) {
        alerts.push({ type: 'warning', message: `Heavy rainfall: ${rain.value.toFixed(1)}mm` });
    }

    const container = document.getElementById('alerts-container');
    if (alerts.length > 0) {
        container.innerHTML = alerts.map(a => `
            <div class="alert alert-${a.type}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span>${a.message}</span>
            </div>
        `).join('');
    }
}

// Helper functions
function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function getStatusClass(type, value) {
    // Simple status logic - customize as needed
    return 'badge-success';
}

function refreshAllSensors() {
    updateDashboard();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    updateDashboard();
    
    // Auto-refresh every 30 seconds
    setInterval(updateDashboard, 30000);
});
</script>
{% endblock content %}